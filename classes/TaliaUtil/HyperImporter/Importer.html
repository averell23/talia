<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <title>Class: TaliaUtil::HyperImporter::Importer</title>
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
  <meta http-equiv="Content-Script-Type" content="text/javascript" />
  <link rel="stylesheet" href="../../.././rdoc-style.css" type="text/css" media="screen" />
  <script type="text/javascript">
  // <![CDATA[

  function popupCode( url ) {
    window.open(url, "Code", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=150,width=400")
  }

  function toggleCode( id ) {
    if ( document.getElementById )
      elem = document.getElementById( id );
    else if ( document.all )
      elem = eval( "document.all." + id );
    else
      return false;

    elemStyle = elem.style;
    
    if ( elemStyle.display != "block" ) {
      elemStyle.display = "block"
    } else {
      elemStyle.display = "none"
    }

    return true;
  }
  
  // Make codeblocks hidden by default
  document.writeln( "<style type=\"text/css\">div.method-source-code { display: none }</style>" )
  
  // ]]>
  </script>

</head>
<body>



    <div id="classHeader">
        <table class="header-table">
        <tr class="top-aligned-row">
          <td><strong>Class</strong></td>
          <td class="class-name-in-header">TaliaUtil::HyperImporter::Importer</td>
        </tr>
        <tr class="top-aligned-row">
            <td><strong>In:</strong></td>
            <td>
                <a href="../../../files/lib/talia_util/hyper_importer/importer/caching_rb.html">
                lib/talia_util/hyper_importer/importer/caching.rb
                </a>
        <br />
                <a href="../../../files/lib/talia_util/hyper_importer/importer/cloning_rb.html">
                lib/talia_util/hyper_importer/importer/cloning.rb
                </a>
        <br />
                <a href="../../../files/lib/talia_util/hyper_importer/importer_rb.html">
                lib/talia_util/hyper_importer/importer.rb
                </a>
        <br />
            </td>
        </tr>

        <tr class="top-aligned-row">
            <td><strong>Parent:</strong></td>
            <td>
                Object
            </td>
        </tr>
        </table>
    </div>
  <!-- banner header -->

  <div id="bodyContent">



  <div id="contextContent">

    <div id="description">
      <p>
Superclass for <a href="Importer.html#M000102">import</a> modules of Hyper
data imports. There is no explicit error handling, just assertions: The <a
href="Importer.html#M000102">import</a> should make a best effort, while
the assertions can be used to report error conditions, if needed.
</p>

    </div>


   </div>

    <div id="method-list">
      <h3 class="section-bar">Methods</h3>

      <div class="name-list">
      <a href="#M000114">add_property_explicit</a>&nbsp;&nbsp;
      <a href="#M000113">add_property_from</a>&nbsp;&nbsp;
      <a href="#M000115">add_rel_from</a>&nbsp;&nbsp;
      <a href="#M000132">add_source_rel</a>&nbsp;&nbsp;
      <a href="#M000141">benchmark</a>&nbsp;&nbsp;
      <a href="#M000123">cached_type_by_string</a>&nbsp;&nbsp;
      <a href="#M000135">check_namespace!</a>&nbsp;&nbsp;
      <a href="#M000134">check_namespaces!</a>&nbsp;&nbsp;
      <a href="#M000105">configured_source_class</a>&nbsp;&nbsp;
      <a href="#M000099">do_import!</a>&nbsp;&nbsp;
      <a href="#M000117">get_class_for</a>&nbsp;&nbsp;
      <a href="#M000120">get_or_create_source</a>&nbsp;&nbsp;
      <a href="#M000118">get_source</a>&nbsp;&nbsp;
      <a href="#M000107">get_source_type</a>&nbsp;&nbsp;
      <a href="#M000119">get_source_with_class</a>&nbsp;&nbsp;
      <a href="#M000112">get_text</a>&nbsp;&nbsp;
      <a href="#M000102">import</a>&nbsp;&nbsp;
      <a href="#M000100">import!</a>&nbsp;&nbsp;
      <a href="#M000111">import_callback_for</a>&nbsp;&nbsp;
      <a href="#M000125">import_file!</a>&nbsp;&nbsp;
      <a href="#M000122">import_relations!</a>&nbsp;&nbsp;
      <a href="#M000124">import_types!</a>&nbsp;&nbsp;
      <a href="#M000103">importer_for_element</a>&nbsp;&nbsp;
      <a href="#M000139">irify</a>&nbsp;&nbsp;
      <a href="#M000131">load_from_data_url!</a>&nbsp;&nbsp;
      <a href="#M000129">load_image_from_url!</a>&nbsp;&nbsp;
      <a href="#M000138">logger</a>&nbsp;&nbsp;
      <a href="#M000116">map_property</a>&nbsp;&nbsp;
      <a href="#M000109">needs_title</a>&nbsp;&nbsp;
      <a href="#M000097">new</a>&nbsp;&nbsp;
      <a href="#M000110">on_import_relation</a>&nbsp;&nbsp;
      <a href="#M000130">open_from_url</a>&nbsp;&nbsp;
      <a href="#M000128">open_original_image_for</a>&nbsp;&nbsp;
      <a href="#M000127">prepare_image_from_existing!</a>&nbsp;&nbsp;
      <a href="#M000136">primary_source</a>&nbsp;&nbsp;
      <a href="#M000137">primary_source?</a>&nbsp;&nbsp;
      <a href="#M000126">process_content_type</a>&nbsp;&nbsp;
      <a href="#M000133">quick_add_predicate</a>&nbsp;&nbsp;
      <a href="#M000121">set_catalog_on</a>&nbsp;&nbsp;
      <a href="#M000098">set_credentials</a>&nbsp;&nbsp;
      <a href="#M000101">source</a>&nbsp;&nbsp;
      <a href="#M000106">source_class</a>&nbsp;&nbsp;
      <a href="#M000104">source_type</a>&nbsp;&nbsp;
      <a href="#M000108">title_required</a>&nbsp;&nbsp;
      <a href="#M000140">underscore</a>&nbsp;&nbsp;
      </div>
    </div>

  </div>


    <!-- if includes -->

    <div id="section">

    <div id="class-list">
      <h3 class="section-bar">Classes and Modules</h3>

      Module <a href="Importer/CachingClassMethods.html" class="link">TaliaUtil::HyperImporter::Importer::CachingClassMethods</a><br />

    </div>




    <div id="attribute-list">
      <h3 class="section-bar">Attributes</h3>

      <div class="name-list">
        <table>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">import_options</td>
          <td class="context-item-value">&nbsp;[RW]&nbsp;</td>
          <td class="context-item-desc">
Any additional options for the <a href="Importer.html#M000102">import</a>

</td>
        </tr>
        </table>
      </div>
    </div>
      


    <!-- if method_list -->
    <div id="methods">
      <h3 class="section-bar">Public Class methods</h3>

      <div id="method-M000102" class="method-detail">
        <a name="M000102"></a>

        <div class="method-heading">
          <a href="#M000102" class="method-signature">
          <span class="method-name">import</span><span class="method-args">(element_xml, options = {})</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
This is called to do the actual <a href="Importer.html#M000102">import</a>.
It will take the XML Element of the element to be imported and return a <a
href="Importer.html#M000097">new</a> Source object
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000102-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000102-source">
<pre>
    <span class="ruby-comment cmt"># File lib/talia_util/hyper_importer/importer.rb, line 77</span>
77:       <span class="ruby-keyword kw">def</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">import</span>(<span class="ruby-identifier">element_xml</span>, <span class="ruby-identifier">options</span> = {})
78:         <span class="ruby-identifier">assit_real_string</span>(<span class="ruby-identifier">element_xml</span>.<span class="ruby-identifier">root</span>.<span class="ruby-identifier">name</span>, <span class="ruby-value str">&quot;XML root element must have a name&quot;</span>)
79:         <span class="ruby-identifier">importer</span> = <span class="ruby-identifier">importer_for_element</span>(<span class="ruby-identifier">element_xml</span>.<span class="ruby-identifier">root</span>)
80:         <span class="ruby-identifier">importer</span>.<span class="ruby-identifier">import_options</span> = <span class="ruby-identifier">options</span> <span class="ruby-keyword kw">if</span>(<span class="ruby-identifier">options</span>)
81:         <span class="ruby-identifier">importer</span>.<span class="ruby-identifier">do_import!</span>
82:         <span class="ruby-identifier">importer</span>.<span class="ruby-identifier">source</span>
83:       <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000097" class="method-detail">
        <a name="M000097"></a>

        <div class="method-heading">
          <a href="#M000097" class="method-signature">
          <span class="method-name">new</span><span class="method-args">(element_xml)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Creates a <a href="Importer.html#M000097">new</a> importer, using the given
element to initialize it. This reads the information from the xml element
into the object.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000097-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000097-source">
<pre>
    <span class="ruby-comment cmt"># File lib/talia_util/hyper_importer/importer.rb, line 29</span>
29:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">initialize</span>(<span class="ruby-identifier">element_xml</span>)
30:         <span class="ruby-identifier">check_namespaces!</span>
31:         <span class="ruby-ivar">@element_xml</span> = <span class="ruby-identifier">element_xml</span>
32:         <span class="ruby-identifier">source_name</span> = <span class="ruby-identifier">get_text</span>(<span class="ruby-identifier">element_xml</span>, <span class="ruby-value str">&quot;siglum&quot;</span>)
33:         <span class="ruby-identifier">assit</span>(<span class="ruby-identifier">source_name</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">source_name</span> <span class="ruby-operator">!=</span> <span class="ruby-value str">&quot;&quot;</span>, <span class="ruby-value str">&quot;Source with no name!&quot;</span>)
34:         <span class="ruby-keyword kw">if</span>(<span class="ruby-identifier">source_name</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">source_name</span> <span class="ruby-operator">!=</span> <span class="ruby-value str">&quot;&quot;</span>)
35:           <span class="ruby-ivar">@source</span> = <span class="ruby-identifier">get_source_with_class</span>(<span class="ruby-identifier">source_name</span>, <span class="ruby-identifier">get_class_for</span>(<span class="ruby-identifier">element_xml</span>))
36:           <span class="ruby-identifier">sigla</span> = <span class="ruby-ivar">@source</span>.<span class="ruby-identifier">hyper</span><span class="ruby-operator">::</span><span class="ruby-identifier">siglum</span>
37:           <span class="ruby-identifier">sigla</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">source_name</span> <span class="ruby-keyword kw">if</span>(<span class="ruby-identifier">sigla</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>) <span class="ruby-comment cmt"># No use to fast-add if we need the size</span>
38:         <span class="ruby-keyword kw">end</span>
39:       <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <h3 class="section-bar">Protected Class methods</h3>

      <div id="method-M000105" class="method-detail">
        <a name="M000105"></a>

        <div class="method-heading">
          <a href="#M000105" class="method-signature">
          <span class="method-name">configured_source_class</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
The Source class that should be used for Source created by this importer
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000105-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000105-source">
<pre>
     <span class="ruby-comment cmt"># File lib/talia_util/hyper_importer/importer.rb, line 108</span>
108:       <span class="ruby-keyword kw">def</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">configured_source_class</span>
109:         <span class="ruby-ivar">@configured_source_class</span>
110:       <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000107" class="method-detail">
        <a name="M000107"></a>

        <div class="method-heading">
          <a href="#M000107" class="method-signature">
          <span class="method-name">get_source_type</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Get the <a href="Importer.html#M000101">source</a> type
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000107-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000107-source">
<pre>
     <span class="ruby-comment cmt"># File lib/talia_util/hyper_importer/importer.rb, line 120</span>
120:       <span class="ruby-keyword kw">def</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">get_source_type</span>
121:         <span class="ruby-ivar">@my_source_type</span>
122:       <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000111" class="method-detail">
        <a name="M000111"></a>

        <div class="method-heading">
          <a href="#M000111" class="method-signature">
          <span class="method-name">import_callback_for</span><span class="method-args">(relation)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000111-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000111-source">
<pre>
     <span class="ruby-comment cmt"># File lib/talia_util/hyper_importer/importer.rb, line 149</span>
149:       <span class="ruby-keyword kw">def</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">import_callback_for</span>(<span class="ruby-identifier">relation</span>)
150:         <span class="ruby-ivar">@import_rel_callbacks</span>[<span class="ruby-identifier">relation</span>] <span class="ruby-keyword kw">if</span>(<span class="ruby-ivar">@import_rel_callbacks</span>)
151:       <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000103" class="method-detail">
        <a name="M000103"></a>

        <div class="method-heading">
          <a href="#M000103" class="method-signature">
          <span class="method-name">importer_for_element</span><span class="method-args">(element)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Gets the importer for a given element name
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000103-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000103-source">
<pre>
    <span class="ruby-comment cmt"># File lib/talia_util/hyper_importer/importer.rb, line 88</span>
88:       <span class="ruby-keyword kw">def</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">importer_for_element</span>(<span class="ruby-identifier">element</span>)
89:         <span class="ruby-keyword kw">begin</span>
90:           <span class="ruby-identifier">klass</span> = <span class="ruby-constant">TaliaUtil</span><span class="ruby-operator">::</span><span class="ruby-constant">HyperImporter</span>.<span class="ruby-identifier">const_get</span>(<span class="ruby-node">&quot;#{element.name.camelize}Importer&quot;</span>)
91:           <span class="ruby-identifier">assit_kind_of</span>(<span class="ruby-constant">Class</span>, <span class="ruby-identifier">klass</span>, <span class="ruby-node">&quot;Could not create a class from #{element.name}&quot;</span>)
92:           <span class="ruby-identifier">klass</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">element</span>)
93:         <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">RuntimeError</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
94:           <span class="ruby-identifier">assit_fail</span>(<span class="ruby-node">&quot;Exception during import: #{e}&quot;</span>)
95:         <span class="ruby-keyword kw">end</span>
96:       <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000109" class="method-detail">
        <a name="M000109"></a>

        <div class="method-heading">
          <a href="#M000109" class="method-signature">
          <span class="method-name">needs_title</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000109-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000109-source">
<pre>
     <span class="ruby-comment cmt"># File lib/talia_util/hyper_importer/importer.rb, line 130</span>
130:       <span class="ruby-keyword kw">def</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">needs_title</span>
131:         <span class="ruby-ivar">@title_required</span> = <span class="ruby-keyword kw">true</span> <span class="ruby-keyword kw">unless</span>(<span class="ruby-keyword kw">defined?</span>(<span class="ruby-ivar">@title_required</span>))
132:       <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000110" class="method-detail">
        <a name="M000110"></a>

        <div class="method-heading">
          <a href="#M000110" class="method-signature">
          <span class="method-name">on_import_relation</span><span class="method-args">(relation, target = nil, &amp;block)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Allows to add a hook that will be called if the given relation is imported.
This can be used to directly add more stuff (like sorting) to a related
object, so that it doesn&#8216;t have to be re-retrieved later on.
</p>
<p>
NOTE: The object <a href="Importer.html#M000101">source</a> that it passed
to the callback will <b>not</b> be saved automatically.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000110-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000110-source">
<pre>
     <span class="ruby-comment cmt"># File lib/talia_util/hyper_importer/importer.rb, line 140</span>
140:       <span class="ruby-keyword kw">def</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">on_import_relation</span>(<span class="ruby-identifier">relation</span>, <span class="ruby-identifier">target</span> = <span class="ruby-keyword kw">nil</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
141:         <span class="ruby-ivar">@import_rel_callbacks</span> <span class="ruby-operator">||=</span> {}
142:         <span class="ruby-identifier">raise</span>(<span class="ruby-constant">ArgumentError</span>, <span class="ruby-value str">&quot;Must give either block or symbol for the callback.&quot;</span>) <span class="ruby-keyword kw">if</span>(<span class="ruby-identifier">target</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">block</span>)
143:         <span class="ruby-identifier">callback</span> = <span class="ruby-identifier">target</span>.<span class="ruby-identifier">to_sym</span> <span class="ruby-keyword kw">if</span>(<span class="ruby-identifier">target</span>)
144:         <span class="ruby-identifier">callback</span> = <span class="ruby-identifier">block</span> <span class="ruby-keyword kw">if</span>(<span class="ruby-identifier">block</span>)
145:         <span class="ruby-identifier">raise</span>(<span class="ruby-constant">ArgumentError</span>, <span class="ruby-value str">&quot;Must give block or symbol for the callback.&quot;</span>) <span class="ruby-keyword kw">unless</span>(<span class="ruby-identifier">callback</span>)
146:         <span class="ruby-ivar">@import_rel_callbacks</span>[<span class="ruby-identifier">relation</span>] = <span class="ruby-identifier">callback</span>
147:       <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000106" class="method-detail">
        <a name="M000106"></a>

        <div class="method-heading">
          <a href="#M000106" class="method-signature">
          <span class="method-name">source_class</span><span class="method-args">(klass)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Select the <a href="Importer.html#M000101">source</a> class to be used for
this importer. This overrides the automatic setting (which is: use the
Source class which matches the name of the element, and fall back to
TaliaCore::Source)
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000106-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000106-source">
<pre>
     <span class="ruby-comment cmt"># File lib/talia_util/hyper_importer/importer.rb, line 115</span>
115:       <span class="ruby-keyword kw">def</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">source_class</span>(<span class="ruby-identifier">klass</span>)
116:         <span class="ruby-ivar">@configured_source_class</span> = <span class="ruby-identifier">klass</span>
117:       <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000104" class="method-detail">
        <a name="M000104"></a>

        <div class="method-heading">
          <a href="#M000104" class="method-signature">
          <span class="method-name">source_type</span><span class="method-args">(type)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Can be used by a subclass to assign a <a
href="Importer.html#M000101">source</a> type for that subclass. E.g.
&lt;tt&gt;<a href="Importer.html#M000104">source_type</a>
&quot;hyper:paragraph&quot;
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000104-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000104-source">
<pre>
     <span class="ruby-comment cmt"># File lib/talia_util/hyper_importer/importer.rb, line 100</span>
100:       <span class="ruby-keyword kw">def</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">source_type</span>(<span class="ruby-identifier">type</span>)
101:         <span class="ruby-comment cmt"># Check if we are not on the base class - this would create a global var</span>
102:         <span class="ruby-identifier">assit</span>(<span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">!=</span> <span class="ruby-constant">Importer</span>, <span class="ruby-value str">&quot;Should never be called on the base class&quot;</span>)
103:         <span class="ruby-ivar">@my_source_type</span> = <span class="ruby-identifier">type</span>
104:         <span class="ruby-identifier">assit_not_nil</span>(<span class="ruby-ivar">@my_source_type</span>)
105:       <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000108" class="method-detail">
        <a name="M000108"></a>

        <div class="method-heading">
          <a href="#M000108" class="method-signature">
          <span class="method-name">title_required</span><span class="method-args">(required)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
This can be used to not require a title on the element (the corresponding
accessor, <a href="Importer.html#M000109">needs_title</a>, will default to
true
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000108-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000108-source">
<pre>
     <span class="ruby-comment cmt"># File lib/talia_util/hyper_importer/importer.rb, line 126</span>
126:       <span class="ruby-keyword kw">def</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">title_required</span>(<span class="ruby-identifier">required</span>)
127:         <span class="ruby-ivar">@title_required</span> = <span class="ruby-identifier">required</span>
128:       <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <h3 class="section-bar">Public Instance methods</h3>

      <div id="method-M000099" class="method-detail">
        <a name="M000099"></a>

        <div class="method-heading">
          <a href="#M000099" class="method-signature">
          <span class="method-name">do_import!</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
This will be called to initiate the <a
href="Importer.html#M000102">import</a> on this importer. this will be
called from self.import, and should not be called directly and should not
be overwritten.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000099-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000099-source">
<pre>
    <span class="ruby-comment cmt"># File lib/talia_util/hyper_importer/importer.rb, line 50</span>
50:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">do_import!</span>
51:         <span class="ruby-identifier">benchmark</span>(<span class="ruby-value str">'Import of '</span> <span class="ruby-operator">+</span> <span class="ruby-ivar">@source</span>.<span class="ruby-identifier">uri</span>.<span class="ruby-identifier">local_name</span>) <span class="ruby-keyword kw">do</span>
52:           <span class="ruby-identifier">benchmark</span>(<span class="ruby-value str">'Import relations'</span>) { <span class="ruby-identifier">import_relations!</span> }
53:           <span class="ruby-identifier">benchmark</span>(<span class="ruby-value str">'Import types'</span>) { <span class="ruby-identifier">import_types!</span> }
54:           <span class="ruby-identifier">benchmark</span>(<span class="ruby-value str">'Top import'</span>) <span class="ruby-keyword kw">do</span>
55:             <span class="ruby-identifier">add_property_from</span>(<span class="ruby-ivar">@element_xml</span>, <span class="ruby-value str">'title'</span>, (<span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">needs_title</span> <span class="ruby-value">? </span><span class="ruby-operator">:</span><span class="ruby-identifier">required</span> <span class="ruby-operator">:</span> <span class="ruby-keyword kw">nil</span>)) <span class="ruby-comment cmt"># The title should always exist</span>
56:             <span class="ruby-identifier">import!</span> <span class="ruby-comment cmt"># Calls the import features of the subclass</span>
57:           <span class="ruby-keyword kw">end</span>
58:           <span class="ruby-ivar">@source</span>.<span class="ruby-identifier">autosave_rdf</span> = <span class="ruby-keyword kw">true</span> <span class="ruby-comment cmt"># Reactivate rdf creation for final save</span>
59:           <span class="ruby-identifier">benchmark</span>(<span class="ruby-value str">&quot;Saving source&quot;</span>, <span class="ruby-constant">Logger</span><span class="ruby-operator">::</span><span class="ruby-constant">DEBUG</span>) <span class="ruby-keyword kw">do</span>
60:             <span class="ruby-ivar">@source</span>.<span class="ruby-identifier">save!</span> <span class="ruby-comment cmt"># Save the source when the import is complete</span>
61:           <span class="ruby-keyword kw">end</span>
62:         <span class="ruby-keyword kw">end</span>
63:       <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000100" class="method-detail">
        <a name="M000100"></a>

        <div class="method-heading">
          <a href="#M000100" class="method-signature">
          <span class="method-name">import!</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Imports the data. To be overwritten by child classes
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000100-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000100-source">
<pre>
    <span class="ruby-comment cmt"># File lib/talia_util/hyper_importer/importer.rb, line 66</span>
66:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">import!</span>
67:         <span class="ruby-identifier">assit_fail</span>(<span class="ruby-value str">&quot;Should never call base class version of import.&quot;</span>)
68:       <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000098" class="method-detail">
        <a name="M000098"></a>

        <div class="method-heading">
          <a href="#M000098" class="method-signature">
          <span class="method-name">set_credentials</span><span class="method-args">(login, password)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Sets the credentials that are use for HTTP downloading files. If this
isn&#8216;t set, it will just be ignored
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000098-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000098-source">
<pre>
    <span class="ruby-comment cmt"># File lib/talia_util/hyper_importer/importer.rb, line 43</span>
43:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">set_credentials</span>(<span class="ruby-identifier">login</span>, <span class="ruby-identifier">password</span>)<span class="ruby-identifier">password</span>
44:         <span class="ruby-ivar">@credentials</span> = { <span class="ruby-identifier">:http_basic_authentication</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-identifier">login</span>, <span class="ruby-identifier">password</span>] }
45:       <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000101" class="method-detail">
        <a name="M000101"></a>

        <div class="method-heading">
          <a href="#M000101" class="method-signature">
          <span class="method-name">source</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Get the <a href="Importer.html#M000101">source</a> that was imported by
this importer.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000101-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000101-source">
<pre>
    <span class="ruby-comment cmt"># File lib/talia_util/hyper_importer/importer.rb, line 71</span>
71:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">source</span>
72:         <span class="ruby-ivar">@source</span>
73:       <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <h3 class="section-bar">Protected Instance methods</h3>

      <div id="method-M000114" class="method-detail">
        <a name="M000114"></a>

        <div class="method-heading">
          <a href="#M000114" class="method-signature">
          <span class="method-name">add_property_explicit</span><span class="method-args">(root, name, property, required = false)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
This adds a property &quot;explicitly&quot;, if the automatic mapping
cannot be used
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000114-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000114-source">
<pre>
     <span class="ruby-comment cmt"># File lib/talia_util/hyper_importer/importer.rb, line 187</span>
187:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">add_property_explicit</span>(<span class="ruby-identifier">root</span>, <span class="ruby-identifier">name</span>, <span class="ruby-identifier">property</span>, <span class="ruby-identifier">required</span> = <span class="ruby-keyword kw">false</span>)
188:         <span class="ruby-keyword kw">if</span>(<span class="ruby-identifier">node</span> = <span class="ruby-identifier">root</span>.<span class="ruby-identifier">elements</span>[<span class="ruby-identifier">name</span>])
189:           <span class="ruby-comment cmt">## Create an URI for the new property</span>
190:           <span class="ruby-identifier">quick_add_predicate</span>(<span class="ruby-ivar">@source</span>, <span class="ruby-identifier">property</span>, <span class="ruby-identifier">node</span>.<span class="ruby-identifier">text</span>.<span class="ruby-identifier">strip</span>) <span class="ruby-keyword kw">if</span>(<span class="ruby-identifier">node</span>.<span class="ruby-identifier">text</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">node</span>.<span class="ruby-identifier">text</span>.<span class="ruby-identifier">strip</span> <span class="ruby-operator">!=</span> <span class="ruby-value str">&quot;&quot;</span>)
191:         <span class="ruby-keyword kw">else</span>
192:           <span class="ruby-identifier">assit</span>(<span class="ruby-operator">!</span><span class="ruby-identifier">required</span>, <span class="ruby-node">&quot;The node #{name} is required to exist.&quot;</span>)
193:         <span class="ruby-keyword kw">end</span>
194:       <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000113" class="method-detail">
        <a name="M000113"></a>

        <div class="method-heading">
          <a href="#M000113" class="method-signature">
          <span class="method-name">add_property_from</span><span class="method-args">(root, name, required = false, default_value = nil)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Creates a <a href="Importer.html#M000097">new</a> attribute on the <a
href="Importer.html#M000101">source</a>, based on the mapping from the
given node. The attribute is assigned a value based on the contend of the
node.
</p>
<p>
The node is acquired in the same way as in <a
href="Importer.html#M000112">get_text</a>.
</p>
<p>
If a default value is given, it will be used as a default when the node
does not exist or is empty.
</p>
<p>
The default value can be the special value :required - which means that
there is no default and
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000113-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000113-source">
<pre>
     <span class="ruby-comment cmt"># File lib/talia_util/hyper_importer/importer.rb, line 173</span>
173:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">add_property_from</span>(<span class="ruby-identifier">root</span>, <span class="ruby-identifier">name</span>, <span class="ruby-identifier">required</span> = <span class="ruby-keyword kw">false</span>, <span class="ruby-identifier">default_value</span> = <span class="ruby-keyword kw">nil</span>)
174:         <span class="ruby-keyword kw">if</span>(<span class="ruby-identifier">node</span> = <span class="ruby-identifier">root</span>.<span class="ruby-identifier">elements</span>[<span class="ruby-identifier">name</span>])
175:           <span class="ruby-comment cmt">## Create an URI for the new property</span>
176:           <span class="ruby-identifier">property</span> = <span class="ruby-constant">N</span><span class="ruby-operator">::</span><span class="ruby-constant">URI</span>.<span class="ruby-identifier">make_uri</span>(<span class="ruby-identifier">map_property</span>(<span class="ruby-identifier">name</span>), <span class="ruby-value str">':'</span>, <span class="ruby-constant">N</span><span class="ruby-operator">::</span><span class="ruby-constant">HYPER</span>)
177:           <span class="ruby-identifier">text</span> = <span class="ruby-identifier">default_value</span>
178:           <span class="ruby-identifier">text</span> = <span class="ruby-identifier">node</span>.<span class="ruby-identifier">text</span>.<span class="ruby-identifier">strip</span> <span class="ruby-keyword kw">if</span>(<span class="ruby-identifier">node</span>.<span class="ruby-identifier">text</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">node</span>.<span class="ruby-identifier">text</span>.<span class="ruby-identifier">strip</span> <span class="ruby-operator">!=</span> <span class="ruby-value str">''</span>)
179:           <span class="ruby-identifier">quick_add_predicate</span>(<span class="ruby-ivar">@source</span>, <span class="ruby-identifier">property</span>, <span class="ruby-identifier">text</span>) <span class="ruby-keyword kw">if</span>(<span class="ruby-identifier">text</span>)
180:         <span class="ruby-keyword kw">else</span>
181:           <span class="ruby-identifier">assit</span>(<span class="ruby-operator">!</span><span class="ruby-identifier">required</span>, <span class="ruby-node">&quot;The node #{name} is required to exist.&quot;</span>)
182:         <span class="ruby-keyword kw">end</span>
183:       <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000115" class="method-detail">
        <a name="M000115"></a>

        <div class="method-heading">
          <a href="#M000115" class="method-signature">
          <span class="method-name">add_rel_from</span><span class="method-args">(root, name, required = false)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Works like add_property from, but will create a relation to the a Source
instead of value
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000115-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000115-source">
<pre>
     <span class="ruby-comment cmt"># File lib/talia_util/hyper_importer/importer.rb, line 198</span>
198:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">add_rel_from</span>(<span class="ruby-identifier">root</span>, <span class="ruby-identifier">name</span>, <span class="ruby-identifier">required</span> = <span class="ruby-keyword kw">false</span>)
199:         <span class="ruby-keyword kw">if</span>(<span class="ruby-identifier">node</span> = <span class="ruby-identifier">root</span>.<span class="ruby-identifier">elements</span>[<span class="ruby-identifier">name</span>])
200:           <span class="ruby-comment cmt">## Create an URI for the new property</span>
201:           <span class="ruby-identifier">property</span> = <span class="ruby-constant">N</span><span class="ruby-operator">::</span><span class="ruby-constant">URI</span>.<span class="ruby-identifier">make_uri</span>(<span class="ruby-identifier">map_property</span>(<span class="ruby-identifier">name</span>), <span class="ruby-value str">':'</span>, <span class="ruby-constant">N</span><span class="ruby-operator">::</span><span class="ruby-constant">HYPER</span>)
202:           <span class="ruby-identifier">add_source_rel</span>(<span class="ruby-identifier">property</span>, <span class="ruby-identifier">node</span>.<span class="ruby-identifier">text</span>.<span class="ruby-identifier">strip</span>) <span class="ruby-keyword kw">if</span>(<span class="ruby-identifier">node</span>.<span class="ruby-identifier">text</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">node</span>.<span class="ruby-identifier">text</span>.<span class="ruby-identifier">strip</span> <span class="ruby-operator">!=</span> <span class="ruby-value str">&quot;&quot;</span>)
203:         <span class="ruby-keyword kw">else</span>
204:           <span class="ruby-identifier">assit</span>(<span class="ruby-operator">!</span><span class="ruby-identifier">required</span>, <span class="ruby-node">&quot;The node n#{name} is required to exist.&quot;</span>)
205:         <span class="ruby-keyword kw">end</span>
206:       <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000132" class="method-detail">
        <a name="M000132"></a>

        <div class="method-heading">
          <a href="#M000132" class="method-signature">
          <span class="method-name">add_source_rel</span><span class="method-args">(relation, destination, origin = nil)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Adds a relation to another <a href="Importer.html#M000101">source</a> from
the Source that is imported. If the related Source does not yet exist it
will be created. This means that a relation <tt>origin -[relation]-&gt;
destination</tt> is created.
</p>
<p>
All parameters should be URI objects or URI strings.
</p>
<p>
The origin is optional. If it isn&#8216;t given, the origin (subject) of
the relation will be the currently imported Source.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000132-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000132-source">
<pre>
     <span class="ruby-comment cmt"># File lib/talia_util/hyper_importer/importer.rb, line 611</span>
611:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">add_source_rel</span>(<span class="ruby-identifier">relation</span>, <span class="ruby-identifier">destination</span>, <span class="ruby-identifier">origin</span> = <span class="ruby-keyword kw">nil</span>)
612:         <span class="ruby-identifier">origin</span> <span class="ruby-operator">||=</span> <span class="ruby-ivar">@source</span>
613:         <span class="ruby-identifier">object_source</span> = <span class="ruby-identifier">get_source</span>(<span class="ruby-identifier">destination</span>)
614:         <span class="ruby-identifier">quick_add_predicate</span>(<span class="ruby-identifier">origin</span>, <span class="ruby-identifier">relation</span>, <span class="ruby-identifier">object_source</span>)
615:         <span class="ruby-comment cmt"># Make sure that 'external' sources are saved with RDF data. For</span>
616:         <span class="ruby-comment cmt"># the member source this will automatically be called on import</span>
617:         <span class="ruby-identifier">origin</span>.<span class="ruby-identifier">autosave_rdf</span> = <span class="ruby-keyword kw">true</span> <span class="ruby-keyword kw">if</span>(<span class="ruby-identifier">origin</span> <span class="ruby-operator">!=</span> <span class="ruby-ivar">@source</span>)
618:       <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000141" class="method-detail">
        <a name="M000141"></a>

        <div class="method-heading">
          <a href="#M000141" class="method-signature">
          <span class="method-name">benchmark</span><span class="method-args">(message, level = Logger::INFO, &amp;block)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Benchmarking helper
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000141-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000141-source">
<pre>
     <span class="ruby-comment cmt"># File lib/talia_util/hyper_importer/importer.rb, line 697</span>
697:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">benchmark</span>(<span class="ruby-identifier">message</span>, <span class="ruby-identifier">level</span> = <span class="ruby-constant">Logger</span><span class="ruby-operator">::</span><span class="ruby-constant">INFO</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
698:         <span class="ruby-keyword kw">unless</span>(<span class="ruby-identifier">logger</span>.<span class="ruby-identifier">level</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-identifier">level</span>)
699:           <span class="ruby-identifier">block</span>.<span class="ruby-identifier">call</span>
700:         <span class="ruby-keyword kw">else</span>
701:           <span class="ruby-identifier">elapsed</span> = <span class="ruby-constant">Benchmark</span>.<span class="ruby-identifier">realtime</span>(<span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
702:           <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">add</span>(<span class="ruby-identifier">level</span>, <span class="ruby-node">&quot;\033[1m\033[4m\033[35m#{self.class.name}\033[0m [Importing #{Time.now.to_s(:long)}] #{message} completed in %.2f secs&quot;</span> <span class="ruby-operator">%</span> <span class="ruby-identifier">elapsed</span>)
703:         <span class="ruby-keyword kw">end</span>
704:       <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000123" class="method-detail">
        <a name="M000123"></a>

        <div class="method-heading">
          <a href="#M000123" class="method-signature">
          <span class="method-name">cached_type_by_string</span><span class="method-args">(value)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Makes an URI of the given value and retrieves a type <a
href="Importer.html#M000101">source</a>, using the type cache
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000123-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000123-source">
<pre>
     <span class="ruby-comment cmt"># File lib/talia_util/hyper_importer/importer.rb, line 372</span>
372:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">cached_type_by_string</span>(<span class="ruby-identifier">value</span>)
373:         <span class="ruby-constant">Importer</span>.<span class="ruby-identifier">type_cache_retrieve</span>(<span class="ruby-constant">N</span><span class="ruby-operator">::</span><span class="ruby-constant">URI</span>.<span class="ruby-identifier">make_uri</span>(<span class="ruby-identifier">value</span>, <span class="ruby-value str">':'</span>, <span class="ruby-constant">N</span><span class="ruby-operator">::</span><span class="ruby-constant">HYPER</span>))
374:       <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000135" class="method-detail">
        <a name="M000135"></a>

        <div class="method-heading">
          <a href="#M000135" class="method-signature">
          <span class="method-name">check_namespace!</span><span class="method-args">(namespace)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Checks a single namespace. Helper for check_namspaces.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000135-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000135-source">
<pre>
     <span class="ruby-comment cmt"># File lib/talia_util/hyper_importer/importer.rb, line 648</span>
648:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">check_namespace!</span>(<span class="ruby-identifier">namespace</span>)
649:         <span class="ruby-identifier">namespace</span> = <span class="ruby-identifier">namespace</span>.<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">upcase</span>
650:         <span class="ruby-keyword kw">unless</span>(<span class="ruby-constant">N</span>.<span class="ruby-identifier">const_defined?</span>(<span class="ruby-identifier">namespace</span>))
651:           <span class="ruby-identifier">raise</span>(<span class="ruby-constant">RuntimeError</span>, <span class="ruby-node">&quot;ATTENTION: Namespace #{namespace} must be defined for the import to work.&quot;</span>)
652:         <span class="ruby-keyword kw">end</span>
653:       <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000134" class="method-detail">
        <a name="M000134"></a>

        <div class="method-heading">
          <a href="#M000134" class="method-signature">
          <span class="method-name">check_namespaces!</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Checks for the namespaces which must be defined for the <a
href="Importer.html#M000102">import</a> to work
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000134-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000134-source">
<pre>
     <span class="ruby-comment cmt"># File lib/talia_util/hyper_importer/importer.rb, line 642</span>
642:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">check_namespaces!</span>
643:         <span class="ruby-identifier">check_namespace!</span>(<span class="ruby-identifier">:HYPER</span>)
644:         <span class="ruby-identifier">check_namespace!</span>(<span class="ruby-identifier">:DCNS</span>)
645:       <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000117" class="method-detail">
        <a name="M000117"></a>

        <div class="method-heading">
          <a href="#M000117" class="method-signature">
          <span class="method-name">get_class_for</span><span class="method-args">(element)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Gets the class of Source that the importer produces
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000117-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000117-source">
<pre>
     <span class="ruby-comment cmt"># File lib/talia_util/hyper_importer/importer.rb, line 217</span>
217:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">get_class_for</span>(<span class="ruby-identifier">element</span>)
218:         <span class="ruby-identifier">config_class</span> = <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">configured_source_class</span>
219:         <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">config_class</span> <span class="ruby-keyword kw">if</span>(<span class="ruby-identifier">config_class</span>) <span class="ruby-comment cmt"># If a class was hard-coded</span>
220:         
221:         <span class="ruby-comment cmt"># Try to select a class by type</span>
222:         <span class="ruby-identifier">type_class</span> = <span class="ruby-keyword kw">nil</span>
223:         <span class="ruby-keyword kw">begin</span>
224:           <span class="ruby-identifier">type</span> = <span class="ruby-identifier">element</span>.<span class="ruby-identifier">name</span>.<span class="ruby-identifier">camelize</span>
225:           <span class="ruby-identifier">type_class</span> = <span class="ruby-constant">TaliaCore</span>.<span class="ruby-identifier">const_get</span>(<span class="ruby-identifier">type</span>)
226:         <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">NameError</span>
227:           <span class="ruby-identifier">type_class</span> = <span class="ruby-constant">TaliaCore</span><span class="ruby-operator">::</span><span class="ruby-constant">Source</span> <span class="ruby-comment cmt"># if nothing was found, use the Source class</span>
228:         <span class="ruby-keyword kw">end</span>
229:         
230:         <span class="ruby-identifier">type_class</span>
231:       <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000120" class="method-detail">
        <a name="M000120"></a>

        <div class="method-heading">
          <a href="#M000120" class="method-signature">
          <span class="method-name">get_or_create_source</span><span class="method-args">(source_uri, klass, save_new = true)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Gets a <a href="Importer.html#M000101">source</a> with the given type (type
must be a class). If the <a href="Importer.html#M000101">source</a> already
exists, this will change the Sources class (type property).
</p>
<p>
If klass is nil, it will default to the Source class but will not attempt
to change the type on existing sources.
</p>
<p>
The sources from the method will <b>not</b> automatically create their RDF
on save!
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000120-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000120-source">
<pre>
     <span class="ruby-comment cmt"># File lib/talia_util/hyper_importer/importer.rb, line 271</span>
271:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">get_or_create_source</span>(<span class="ruby-identifier">source_uri</span>, <span class="ruby-identifier">klass</span>, <span class="ruby-identifier">save_new</span> = <span class="ruby-keyword kw">true</span>)
272:         <span class="ruby-identifier">set_class</span> = (<span class="ruby-identifier">klass</span> <span class="ruby-operator">!=</span> <span class="ruby-keyword kw">nil</span>) <span class="ruby-comment cmt"># this indicates if the class must be reset on an existing object</span>
273:         <span class="ruby-identifier">foo</span> = <span class="ruby-identifier">klass</span>.<span class="ruby-identifier">new</span>(<span class="ruby-value str">'foo'</span>) <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">klass</span>.<span class="ruby-identifier">nil?</span>
274:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">foo</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">TaliaCore</span><span class="ruby-operator">::</span><span class="ruby-constant">ExpressionCard</span>)
275:           <span class="ruby-identifier">catalog</span> = <span class="ruby-identifier">get_catalog</span>()
276:           <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">catalog</span>.<span class="ruby-identifier">nil?</span>
277:             <span class="ruby-identifier">base_uri</span> = <span class="ruby-constant">N</span><span class="ruby-operator">::</span><span class="ruby-constant">LOCAL</span>
278:           <span class="ruby-keyword kw">else</span>
279:             <span class="ruby-identifier">base_uri</span> = <span class="ruby-identifier">catalog</span>.<span class="ruby-identifier">uri</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-value str">&quot;/&quot;</span>
280:           <span class="ruby-keyword kw">end</span>
281:           <span class="ruby-identifier">source_name</span> = <span class="ruby-identifier">source_uri</span>.<span class="ruby-identifier">local_name</span>.<span class="ruby-identifier">to_s</span>
282:           <span class="ruby-identifier">source_uri</span> = <span class="ruby-identifier">irify</span>(<span class="ruby-identifier">base_uri</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">source_name</span>)
283:         <span class="ruby-keyword kw">end</span>
284: 
285:         <span class="ruby-identifier">klass</span> <span class="ruby-operator">||=</span> <span class="ruby-constant">TaliaCore</span><span class="ruby-operator">::</span><span class="ruby-constant">Source</span>
286:         <span class="ruby-identifier">raise</span>(<span class="ruby-constant">ArgumentError</span>, <span class="ruby-node">&quot;This must have a klass as parameter: #{source_uri}&quot;</span>) <span class="ruby-keyword kw">unless</span>(<span class="ruby-identifier">klass</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Class</span>))
287:         <span class="ruby-identifier">src</span> = <span class="ruby-constant">SourceCache</span>.<span class="ruby-identifier">cache</span>[<span class="ruby-identifier">source_uri</span>]
288:         <span class="ruby-keyword kw">if</span>(<span class="ruby-identifier">src</span>)
289:           <span class="ruby-comment cmt"># If the Source already exists, push the types in</span>
290:           <span class="ruby-identifier">src</span>.<span class="ruby-identifier">autosave_rdf</span> = <span class="ruby-keyword kw">false</span>
291:           <span class="ruby-comment cmt"># If the class</span>
292:           <span class="ruby-identifier">klass_name</span> = <span class="ruby-identifier">klass</span>.<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">demodulize</span>
293:           <span class="ruby-keyword kw">if</span>((<span class="ruby-identifier">src</span>[<span class="ruby-identifier">:type</span>] <span class="ruby-operator">!=</span> <span class="ruby-identifier">klass_name</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">set_class</span>)
294:             <span class="ruby-comment cmt"># In this case we will have to change the STI type on the Source</span>
295:             <span class="ruby-comment cmt"># this happens if the Source had been created before the import</span>
296:             <span class="ruby-comment cmt"># as a referenced object on another Source</span>
297:             <span class="ruby-identifier">assit</span>(<span class="ruby-identifier">src</span>[<span class="ruby-identifier">:type</span>] <span class="ruby-operator">==</span> <span class="ruby-value str">'Source'</span>, <span class="ruby-node">&quot;Source should not change from #{src[:type]} to #{klass_name}: #{src.uri} &quot;</span>)
298:             <span class="ruby-identifier">src</span>[<span class="ruby-identifier">:type</span>] = <span class="ruby-identifier">klass_name</span>
299:             <span class="ruby-identifier">src</span>.<span class="ruby-identifier">save!</span>
300:             <span class="ruby-identifier">src</span> = <span class="ruby-identifier">klass</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">src</span>.<span class="ruby-identifier">id</span>)
301:             <span class="ruby-identifier">set_catalog_on</span>(<span class="ruby-identifier">src</span>)
302:             <span class="ruby-comment cmt"># Update the cache with the changed source!</span>
303:             <span class="ruby-constant">SourceCache</span>.<span class="ruby-identifier">cache</span>[<span class="ruby-identifier">source_uri</span>] = <span class="ruby-identifier">src</span>
304:             <span class="ruby-identifier">src</span>.<span class="ruby-identifier">autosave_rdf</span> = <span class="ruby-keyword kw">false</span>
305:           <span class="ruby-keyword kw">end</span>
306:         <span class="ruby-keyword kw">else</span>
307:           <span class="ruby-identifier">src</span> = <span class="ruby-identifier">klass</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">source_uri</span>)
308:           <span class="ruby-identifier">src</span>.<span class="ruby-identifier">primary_source</span> = <span class="ruby-identifier">primary_source?</span> <span class="ruby-keyword kw">if</span>(<span class="ruby-identifier">src</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">TaliaCore</span><span class="ruby-operator">::</span><span class="ruby-constant">Source</span>))
309:           <span class="ruby-identifier">set_catalog_on</span>(<span class="ruby-identifier">src</span>)
310:           <span class="ruby-identifier">src</span>.<span class="ruby-identifier">autosave_rdf</span> = <span class="ruby-keyword kw">false</span>
311:           <span class="ruby-identifier">src</span>.<span class="ruby-identifier">save!</span> <span class="ruby-keyword kw">if</span>(<span class="ruby-identifier">save_new</span>)
312:           <span class="ruby-comment cmt"># Add the new source to the cache</span>
313:           <span class="ruby-constant">SourceCache</span>.<span class="ruby-identifier">cache</span>[<span class="ruby-identifier">source_uri</span>] = <span class="ruby-identifier">src</span>
314:         <span class="ruby-keyword kw">end</span>
315:         
316:         <span class="ruby-identifier">src</span>
317:       <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000118" class="method-detail">
        <a name="M000118"></a>

        <div class="method-heading">
          <a href="#M000118" class="method-signature">
          <span class="method-name">get_source</span><span class="method-args">(source_name, *types)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Gets or creates the Source with the given name. If the Source already
exists, it will add the given types to it
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000118-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000118-source">
<pre>
     <span class="ruby-comment cmt"># File lib/talia_util/hyper_importer/importer.rb, line 235</span>
235:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">get_source</span>(<span class="ruby-identifier">source_name</span>, <span class="ruby-operator">*</span><span class="ruby-identifier">types</span>)
236:         
237:         <span class="ruby-identifier">src</span> = <span class="ruby-identifier">get_source_with_class</span>(<span class="ruby-identifier">source_name</span>, <span class="ruby-keyword kw">nil</span>)
238:         <span class="ruby-identifier">assit_kind_of</span>(<span class="ruby-constant">TaliaCore</span><span class="ruby-operator">::</span><span class="ruby-constant">Source</span>, <span class="ruby-identifier">src</span>)
239:         
240:         <span class="ruby-keyword kw">if</span>(<span class="ruby-identifier">types</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>) <span class="ruby-comment cmt"># Bail out if there are no types</span>
241:           <span class="ruby-identifier">type_list</span> = <span class="ruby-identifier">src</span>.<span class="ruby-identifier">types</span>
242:           <span class="ruby-identifier">touched</span> = <span class="ruby-keyword kw">false</span>
243:           <span class="ruby-identifier">types</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">type</span><span class="ruby-operator">|</span>
244:             <span class="ruby-keyword kw">unless</span>(<span class="ruby-identifier">type_list</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">type</span>))
245:               <span class="ruby-identifier">type_list</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">type</span>
246:               <span class="ruby-identifier">touched</span> = <span class="ruby-keyword kw">true</span>
247:             <span class="ruby-keyword kw">end</span>
248:           <span class="ruby-keyword kw">end</span>
249:           <span class="ruby-comment cmt"># Only save if there were types modified</span>
250:           <span class="ruby-identifier">src</span>.<span class="ruby-identifier">save!</span> <span class="ruby-keyword kw">if</span>(<span class="ruby-identifier">touched</span>)
251:         <span class="ruby-keyword kw">end</span>
252:         
253:         <span class="ruby-identifier">src</span>
254:       <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000119" class="method-detail">
        <a name="M000119"></a>

        <div class="method-heading">
          <a href="#M000119" class="method-signature">
          <span class="method-name">get_source_with_class</span><span class="method-args">(source_name, klass, save_new = true)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Get the given <a href="Importer.html#M000101">source</a> from a <a
href="Importer.html#M000101">source</a> name (see <a
href="Importer.html#M000120">get_or_create_source</a>), this will create a
<a href="Importer.html#M000101">source</a> with the given name in the local
namespace
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000119-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000119-source">
<pre>
     <span class="ruby-comment cmt"># File lib/talia_util/hyper_importer/importer.rb, line 258</span>
258:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">get_source_with_class</span>(<span class="ruby-identifier">source_name</span>, <span class="ruby-identifier">klass</span>, <span class="ruby-identifier">save_new</span> = <span class="ruby-keyword kw">true</span>)
259:         <span class="ruby-identifier">source_uri</span> = <span class="ruby-identifier">irify</span>(<span class="ruby-constant">N</span><span class="ruby-operator">::</span><span class="ruby-constant">LOCAL</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">source_name</span>)
260:         <span class="ruby-identifier">get_or_create_source</span>(<span class="ruby-identifier">source_uri</span>, <span class="ruby-identifier">klass</span>, <span class="ruby-identifier">save_new</span>)
261:       <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000112" class="method-detail">
        <a name="M000112"></a>

        <div class="method-heading">
          <a href="#M000112" class="method-signature">
          <span class="method-name">get_text</span><span class="method-args">(root, name)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Gets the content of an element as a string. This looks for the direct child
of the root element with the given name, and returns the text contained in
that element - if any.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000112-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000112-source">
<pre>
     <span class="ruby-comment cmt"># File lib/talia_util/hyper_importer/importer.rb, line 156</span>
156:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">get_text</span>(<span class="ruby-identifier">root</span>, <span class="ruby-identifier">name</span>)
157:         <span class="ruby-keyword kw">if</span>(<span class="ruby-identifier">node</span> = <span class="ruby-identifier">root</span>.<span class="ruby-identifier">elements</span>[<span class="ruby-identifier">name</span>])
158:           <span class="ruby-identifier">node</span>.<span class="ruby-identifier">text</span>.<span class="ruby-identifier">strip</span> <span class="ruby-keyword kw">if</span>(<span class="ruby-identifier">node</span>.<span class="ruby-identifier">text</span>)
159:         <span class="ruby-keyword kw">end</span>
160:       <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000125" class="method-detail">
        <a name="M000125"></a>

        <div class="method-heading">
          <a href="#M000125" class="method-signature">
          <span class="method-name">import_file!</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Imports the file that is included in the xml, and all releant properties
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000125-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000125-source">
<pre>
     <span class="ruby-comment cmt"># File lib/talia_util/hyper_importer/importer.rb, line 401</span>
401:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">import_file!</span>
402:         <span class="ruby-identifier">file_name</span> = <span class="ruby-identifier">get_text</span>(<span class="ruby-ivar">@element_xml</span>, <span class="ruby-value str">'file_name'</span>)
403:         <span class="ruby-identifier">file_url</span> = <span class="ruby-identifier">get_text</span>(<span class="ruby-ivar">@element_xml</span>, <span class="ruby-value str">'file_url'</span>)
404:         <span class="ruby-identifier">file_content_type</span> = <span class="ruby-identifier">get_text</span>(<span class="ruby-ivar">@element_xml</span>, <span class="ruby-value str">'file_content_type'</span>)
405:         <span class="ruby-keyword kw">if</span>(<span class="ruby-identifier">file_name</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">file_url</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">file_content_type</span>)
406:           <span class="ruby-identifier">benchmark</span>(<span class="ruby-value str">'Importing file '</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">file_url</span>) <span class="ruby-keyword kw">do</span>
407:             <span class="ruby-keyword kw">begin</span>
408:             
409:               <span class="ruby-comment cmt"># First, check the data type of the file - we'll use the file name</span>
410:               <span class="ruby-comment cmt"># extension for that at the moment - not the file_content_type</span>
411:               <span class="ruby-identifier">file_ext</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">extname</span>(<span class="ruby-identifier">file_name</span>).<span class="ruby-identifier">downcase</span>
412:               <span class="ruby-identifier">mime_type</span> = <span class="ruby-identifier">process_content_type</span>(<span class="ruby-identifier">file_content_type</span>, <span class="ruby-identifier">file_ext</span>)
413:               <span class="ruby-identifier">data_records</span> = <span class="ruby-keyword kw">if</span>(<span class="ruby-node">%w(.xml .hnml .tei .html .htm .xhtml)</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">file_ext</span>))
414:                 <span class="ruby-identifier">load_from_data_url!</span>(<span class="ruby-identifier">:XmlData</span>, <span class="ruby-identifier">file_name</span>, <span class="ruby-identifier">file_url</span>)
415:               <span class="ruby-keyword kw">elsif</span>(<span class="ruby-node">%w(.jpg .gif .jpeg .png .tif)</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">file_ext</span>))
416:                 <span class="ruby-identifier">load_image_from_url!</span>(<span class="ruby-identifier">file_name</span>, <span class="ruby-identifier">file_url</span>)
417:               <span class="ruby-keyword kw">elsif</span>(<span class="ruby-node">%w(.txt)</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">file_ext</span>))
418:                 <span class="ruby-identifier">load_from_data_url!</span>(<span class="ruby-identifier">:SimpleText</span>, <span class="ruby-identifier">file_name</span>, <span class="ruby-identifier">file_url</span>)
419:               <span class="ruby-keyword kw">elsif</span>(<span class="ruby-node">%w(.pdf)</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">file_ext</span>))
420:                 <span class="ruby-identifier">load_from_data_url!</span>(<span class="ruby-identifier">:PdfData</span>, <span class="ruby-identifier">file_name</span>, <span class="ruby-identifier">file_url</span>)
421:               <span class="ruby-keyword kw">end</span>
422:             
423:               <span class="ruby-comment cmt"># Check if we really got a data object, otherwise bail out</span>
424:               <span class="ruby-keyword kw">unless</span>(<span class="ruby-identifier">data_records</span> <span class="ruby-operator">&amp;&amp;</span> (<span class="ruby-identifier">data_records</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>))
425:                 <span class="ruby-identifier">assit_fail</span>(<span class="ruby-node">&quot;Got unknown file extension: #{file_ext}, aborting import&quot;</span>)
426:                 <span class="ruby-keyword kw">return</span>
427:               <span class="ruby-keyword kw">end</span>
428:             
429:               <span class="ruby-identifier">data_records</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">data</span><span class="ruby-operator">|</span> <span class="ruby-ivar">@source</span>.<span class="ruby-identifier">data_records</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">data</span> }
430:               <span class="ruby-identifier">quick_add_predicate</span>(<span class="ruby-ivar">@source</span>, <span class="ruby-constant">N</span><span class="ruby-operator">::</span><span class="ruby-constant">DCNS</span><span class="ruby-operator">::</span><span class="ruby-identifier">format</span>, <span class="ruby-identifier">mime_type</span>)
431:             <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Exception</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
432:               <span class="ruby-identifier">assit_fail</span>(<span class="ruby-node">&quot;Exeption importing file #{file_name}: #{e}\n#{e.backtrace.join(&quot;\n&quot;)}\n&quot;</span>)
433:             <span class="ruby-keyword kw">end</span>
434:           <span class="ruby-keyword kw">end</span>
435:         <span class="ruby-keyword kw">else</span>
436:           <span class="ruby-identifier">assit</span>(<span class="ruby-operator">!</span><span class="ruby-identifier">file_name</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">file_url</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">file_content_type</span>, <span class="ruby-node">&quot;Incomplete file definition on Source #{@source.uri.local_name}&quot;</span>)
437:         <span class="ruby-keyword kw">end</span>
438:       <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000122" class="method-detail">
        <a name="M000122"></a>

        <div class="method-heading">
          <a href="#M000122" class="method-signature">
          <span class="method-name">import_relations!</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Reads all the relations on a Source that are given in the
&quot;relations&quot; element.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000122-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000122-source">
<pre>
     <span class="ruby-comment cmt"># File lib/talia_util/hyper_importer/importer.rb, line 333</span>
333:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">import_relations!</span>
334:         <span class="ruby-ivar">@element_xml</span>.<span class="ruby-identifier">root</span>.<span class="ruby-identifier">elements</span>.<span class="ruby-identifier">each</span>(<span class="ruby-value str">&quot;relations/relation&quot;</span>) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">rel</span><span class="ruby-operator">|</span>
335:           <span class="ruby-comment cmt"># Add each relation with predicate and object</span>
336:           <span class="ruby-keyword kw">begin</span>
337:             <span class="ruby-keyword kw">if</span>((<span class="ruby-identifier">object</span> = <span class="ruby-identifier">get_text</span>(<span class="ruby-identifier">rel</span>, <span class="ruby-value str">'object'</span>)) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">object</span> <span class="ruby-operator">!=</span> <span class="ruby-value str">''</span>)
338:               <span class="ruby-identifier">predicate</span> = <span class="ruby-identifier">map_property</span>(<span class="ruby-identifier">get_text</span>(<span class="ruby-identifier">rel</span>, <span class="ruby-value str">'predicate'</span>))
339:               <span class="ruby-identifier">assit_real_string</span>(<span class="ruby-identifier">predicate</span>, <span class="ruby-node">&quot;Predicate missing. Object: #{object}&quot;</span>)
340:               <span class="ruby-identifier">assit_real_string</span>(<span class="ruby-identifier">object</span>, <span class="ruby-node">&quot;Object missing. Predicate: #{predicate}&quot;</span>)
341:               <span class="ruby-comment cmt"># Now we need to create/get the source for the relation,</span>
342:               <span class="ruby-comment cmt"># and assign it to the current source</span>
343:               <span class="ruby-identifier">predicate_uri</span> = <span class="ruby-constant">N</span><span class="ruby-operator">::</span><span class="ruby-constant">URI</span>.<span class="ruby-identifier">make_uri</span>(<span class="ruby-identifier">predicate</span>, <span class="ruby-value str">':'</span>, <span class="ruby-constant">N</span><span class="ruby-operator">::</span><span class="ruby-constant">HYPER</span>)
344:               
345:               <span class="ruby-identifier">object_source</span> = <span class="ruby-identifier">get_source</span>(<span class="ruby-identifier">object</span>)
346: 
347:               <span class="ruby-identifier">quick_add_predicate</span>(<span class="ruby-ivar">@source</span>, <span class="ruby-identifier">predicate_uri</span>, <span class="ruby-identifier">object_source</span>)
348:               
349:               <span class="ruby-keyword kw">if</span>(<span class="ruby-identifier">callback</span> = <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">import_callback_for</span>(<span class="ruby-identifier">predicate_uri</span>))
350:                 <span class="ruby-keyword kw">case</span> <span class="ruby-identifier">callback</span>
351:                 <span class="ruby-keyword kw">when</span> <span class="ruby-constant">Symbol</span>
352:                   <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">send</span>(<span class="ruby-identifier">callback</span>, <span class="ruby-identifier">object_source</span>)
353:                 <span class="ruby-keyword kw">when</span> <span class="ruby-constant">Proc</span>
354:                   <span class="ruby-identifier">callback</span>.<span class="ruby-identifier">call</span>(<span class="ruby-identifier">object_source</span>)
355:                 <span class="ruby-keyword kw">else</span>
356:                   <span class="ruby-identifier">raise</span>(<span class="ruby-constant">ArgumentError</span>, <span class="ruby-value str">&quot;Illegal callback.&quot;</span>)
357:                 <span class="ruby-keyword kw">end</span>
358:               <span class="ruby-keyword kw">end</span>
359:               
360:             <span class="ruby-keyword kw">else</span>
361:               <span class="ruby-comment cmt"># Skip empty object for relation</span>
362:             <span class="ruby-keyword kw">end</span>
363:           <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Exception</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
364:             <span class="ruby-identifier">assit_fail</span>(<span class="ruby-node">&quot;Error '#{e}' during relation import (#{predicate}, #{object}), possibly malformed XML?\n Backtrace: #{e.backtrace.join(&quot;\n&quot;)}\n&quot;</span>)
365:           <span class="ruby-keyword kw">end</span>
366:         <span class="ruby-keyword kw">end</span>
367:       <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000124" class="method-detail">
        <a name="M000124"></a>

        <div class="method-heading">
          <a href="#M000124" class="method-signature">
          <span class="method-name">import_types!</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Add the types by using the type map and the type configured in the
importer.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000124-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000124-source">
<pre>
     <span class="ruby-comment cmt"># File lib/talia_util/hyper_importer/importer.rb, line 378</span>
378:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">import_types!</span>
379:         <span class="ruby-identifier">types</span> = <span class="ruby-ivar">@source</span>.<span class="ruby-identifier">types</span>
380:         <span class="ruby-keyword kw">if</span>(<span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">get_source_type</span>)
381:           <span class="ruby-identifier">quick_add_predicate</span>(<span class="ruby-ivar">@source</span>, <span class="ruby-constant">N</span><span class="ruby-operator">::</span><span class="ruby-constant">RDF</span>.<span class="ruby-identifier">type</span>, <span class="ruby-identifier">cached_type_by_string</span>(<span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">get_source_type</span>))
382:         <span class="ruby-keyword kw">end</span>
383:         
384:         <span class="ruby-identifier">hyper_type</span> = <span class="ruby-identifier">get_text</span>(<span class="ruby-ivar">@element_xml</span>, <span class="ruby-value str">'type'</span>)
385:         <span class="ruby-identifier">hyper_subtype</span> = <span class="ruby-identifier">get_text</span>(<span class="ruby-ivar">@element_xml</span>, <span class="ruby-value str">'subtype'</span>)
386:         
387:         <span class="ruby-keyword kw">if</span>(<span class="ruby-identifier">hyper_subtype</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-constant">TYPE_MAP</span>[<span class="ruby-identifier">hyper_subtype</span>])
388:           <span class="ruby-identifier">quick_add_predicate</span>(<span class="ruby-ivar">@source</span>, <span class="ruby-constant">N</span><span class="ruby-operator">::</span><span class="ruby-constant">RDF</span>.<span class="ruby-identifier">type</span>, <span class="ruby-identifier">cached_type_by_string</span>(<span class="ruby-constant">TYPE_MAP</span>[<span class="ruby-identifier">hyper_subtype</span>]))
389:         <span class="ruby-keyword kw">elsif</span>(<span class="ruby-identifier">hyper_type</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-constant">TYPE_MAP</span>[<span class="ruby-identifier">hyper_type</span>])
390:           <span class="ruby-identifier">quick_add_predicate</span>(<span class="ruby-ivar">@source</span>, <span class="ruby-constant">N</span><span class="ruby-operator">::</span><span class="ruby-constant">RDF</span>.<span class="ruby-identifier">type</span>, <span class="ruby-identifier">cached_type_by_string</span>(<span class="ruby-constant">TYPE_MAP</span>[<span class="ruby-identifier">hyper_type</span>]))
391:         <span class="ruby-keyword kw">else</span>
392:           <span class="ruby-identifier">assit</span>(<span class="ruby-operator">!</span><span class="ruby-identifier">hyper_type</span>, <span class="ruby-node">&quot;There was no mapping for the type/subtype (#{hyper_type}/#{hyper_subtype})&quot;</span>)
393:         <span class="ruby-keyword kw">end</span>
394:         
395:         <span class="ruby-comment cmt"># Little kludge: We also &quot;hardwire&quot; original types to the object</span>
396:         <span class="ruby-identifier">quick_add_predicate</span>(<span class="ruby-ivar">@source</span>, <span class="ruby-constant">N</span><span class="ruby-operator">::</span><span class="ruby-constant">HYPER</span>.<span class="ruby-identifier">subtype</span>, <span class="ruby-identifier">hyper_subtype</span>) <span class="ruby-keyword kw">if</span>(<span class="ruby-identifier">hyper_subtype</span>)
397:         <span class="ruby-identifier">quick_add_predicate</span>(<span class="ruby-ivar">@source</span>, <span class="ruby-constant">N</span><span class="ruby-operator">::</span><span class="ruby-constant">HYPER</span>.<span class="ruby-identifier">type</span>, <span class="ruby-identifier">hyper_type</span>) <span class="ruby-keyword kw">if</span>(<span class="ruby-identifier">hyper_type</span>)
398:       <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000139" class="method-detail">
        <a name="M000139"></a>

        <div class="method-heading">
          <a href="#M000139" class="method-signature">
          <span class="method-name">irify</span><span class="method-args">(uri)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Removes all characters that are illegal in IRIs, so that the URIs can be
imported
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000139-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000139-source">
<pre>
     <span class="ruby-comment cmt"># File lib/talia_util/hyper_importer/importer.rb, line 683</span>
683:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">irify</span>(<span class="ruby-identifier">uri</span>)
684:         <span class="ruby-constant">N</span><span class="ruby-operator">::</span><span class="ruby-constant">URI</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">uri</span>.<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">gsub</span>( <span class="ruby-regexp re">/[{}|\\^`\s]/</span>, <span class="ruby-value str">'+'</span>))
685:       <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000131" class="method-detail">
        <a name="M000131"></a>

        <div class="method-heading">
          <a href="#M000131" class="method-signature">
          <span class="method-name">load_from_data_url!</span><span class="method-args">(record_type, location, url)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Loads a data file from the given URL. This passes creates the given record
from the data at the given URL, using the given location string on the data
record.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000131-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000131-source">
<pre>
     <span class="ruby-comment cmt"># File lib/talia_util/hyper_importer/importer.rb, line 586</span>
586:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">load_from_data_url!</span>(<span class="ruby-identifier">record_type</span>, <span class="ruby-identifier">location</span>, <span class="ruby-identifier">url</span>)
587:         <span class="ruby-identifier">data_record</span> = <span class="ruby-constant">TaliaCore</span><span class="ruby-operator">::</span><span class="ruby-constant">DataTypes</span>.<span class="ruby-identifier">const_get</span>(<span class="ruby-identifier">record_type</span>).<span class="ruby-identifier">new</span>
588:         
589:         <span class="ruby-comment cmt"># Let's first try if the url is a real file. In this case, we can</span>
590:         <span class="ruby-comment cmt"># save ourselves a lot of heavy lifting.</span>
591:         <span class="ruby-keyword kw">if</span>(<span class="ruby-constant">File</span>.<span class="ruby-identifier">exist?</span>(<span class="ruby-identifier">url</span>))
592:           <span class="ruby-identifier">data_record</span>.<span class="ruby-identifier">create_from_file</span>(<span class="ruby-identifier">location</span>, <span class="ruby-identifier">url</span>)
593:         <span class="ruby-keyword kw">else</span>
594:           <span class="ruby-identifier">open_from_url</span>(<span class="ruby-identifier">url</span>) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">io</span><span class="ruby-operator">|</span>
595:             <span class="ruby-identifier">data_record</span>.<span class="ruby-identifier">create_from_data</span>(<span class="ruby-identifier">location</span>, <span class="ruby-identifier">io</span>) 
596:           <span class="ruby-keyword kw">end</span>
597:         <span class="ruby-keyword kw">end</span>
598:         
599:         [ <span class="ruby-identifier">data_record</span> ]
600:       <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000129" class="method-detail">
        <a name="M000129"></a>

        <div class="method-heading">
          <a href="#M000129" class="method-signature">
          <span class="method-name">load_image_from_url!</span><span class="method-args">(location, url)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Loads an image for the given URL. This is a tad more complex than loading
the data into a data record: It will create both an IIP data object and an
Image data object. The image data record will contain the original image
file. If the original image is not a JPEG or PNG file, it will be converted
to PNG. (This is to always have an original image that can be converted to
PDF).
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000129-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000129-source">
<pre>
     <span class="ruby-comment cmt"># File lib/talia_util/hyper_importer/importer.rb, line 533</span>
533:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">load_image_from_url!</span>(<span class="ruby-identifier">location</span>, <span class="ruby-identifier">url</span>)
534:         <span class="ruby-identifier">iip_record</span> = <span class="ruby-constant">TaliaCore</span><span class="ruby-operator">::</span><span class="ruby-constant">DataTypes</span><span class="ruby-operator">::</span><span class="ruby-constant">IipData</span>.<span class="ruby-identifier">new</span>
535:         <span class="ruby-identifier">image_record</span> = <span class="ruby-constant">TaliaCore</span><span class="ruby-operator">::</span><span class="ruby-constant">DataTypes</span><span class="ruby-operator">::</span><span class="ruby-constant">ImageData</span>.<span class="ruby-identifier">new</span>
536:         <span class="ruby-identifier">records</span> = [<span class="ruby-identifier">iip_record</span>, <span class="ruby-identifier">image_record</span>]
537:         <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">records</span> <span class="ruby-keyword kw">if</span>(<span class="ruby-identifier">prepare_image_from_existing!</span>(<span class="ruby-identifier">iip_record</span>, <span class="ruby-identifier">image_record</span>, <span class="ruby-identifier">url</span>, <span class="ruby-identifier">location</span>))
538: 
539:         <span class="ruby-identifier">is_file</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">exists?</span>(<span class="ruby-identifier">url</span>)
540:         <span class="ruby-identifier">ext</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">extname</span>(<span class="ruby-identifier">url</span>).<span class="ruby-identifier">downcase</span>
541:         <span class="ruby-keyword kw">if</span>(<span class="ruby-node">%w(.jpeg .jpg .png)</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">ext</span>)) <span class="ruby-comment cmt"># The image doesn't need conversion</span>
542:           <span class="ruby-keyword kw">if</span>(<span class="ruby-identifier">is_file</span>)
543:             <span class="ruby-identifier">iip_record</span>.<span class="ruby-identifier">create_from_file</span>(<span class="ruby-identifier">location</span>, <span class="ruby-identifier">url</span>)
544:             <span class="ruby-identifier">image_record</span>.<span class="ruby-identifier">create_from_file</span>(<span class="ruby-identifier">location</span>, <span class="ruby-identifier">url</span>)
545:           <span class="ruby-keyword kw">else</span>
546:             <span class="ruby-identifier">open_from_url</span>(<span class="ruby-identifier">url</span>) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">io</span><span class="ruby-operator">|</span>
547:               <span class="ruby-identifier">data</span> = <span class="ruby-identifier">io</span>.<span class="ruby-identifier">read</span> <span class="ruby-comment cmt"># Cache the data to use it with both records</span>
548:               <span class="ruby-identifier">iip_record</span>.<span class="ruby-identifier">create_from_data</span>(<span class="ruby-identifier">location</span>, <span class="ruby-identifier">data</span>)
549:               <span class="ruby-identifier">iip_record</span>.<span class="ruby-identifier">create_from_data</span>(<span class="ruby-identifier">location</span>, <span class="ruby-identifier">data</span>)
550:             <span class="ruby-keyword kw">end</span>
551:           <span class="ruby-keyword kw">end</span>
552:         <span class="ruby-keyword kw">else</span>
553:           <span class="ruby-comment cmt"># We have an image that needs to be converted</span>
554:           <span class="ruby-identifier">open_original_image_for</span>(<span class="ruby-identifier">url</span>) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">io</span><span class="ruby-operator">|</span>
555:             <span class="ruby-identifier">data</span> = <span class="ruby-identifier">io</span>.<span class="ruby-identifier">read</span> <span class="ruby-comment cmt"># Cache the data to use it with both records</span>
556:             <span class="ruby-identifier">iip_record</span>.<span class="ruby-identifier">create_from_data</span>(<span class="ruby-identifier">location</span>, <span class="ruby-identifier">data</span>)
557:             <span class="ruby-identifier">iip_record</span>.<span class="ruby-identifier">create_from_data</span>(<span class="ruby-identifier">location</span>, <span class="ruby-identifier">data</span>)
558:           <span class="ruby-keyword kw">end</span>
559:         <span class="ruby-keyword kw">end</span>
560: 
561:         <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">records</span>
562:       <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000138" class="method-detail">
        <a name="M000138"></a>

        <div class="method-heading">
          <a href="#M000138" class="method-signature">
          <span class="method-name">logger</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Gain access to the <a href="Importer.html#M000138">logger</a>
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000138-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000138-source">
<pre>
     <span class="ruby-comment cmt"># File lib/talia_util/hyper_importer/importer.rb, line 677</span>
677:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">logger</span>
678:         <span class="ruby-constant">TaliaCore</span><span class="ruby-operator">::</span><span class="ruby-constant">Initializer</span>.<span class="ruby-identifier">talia_logger</span>
679:       <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000116" class="method-detail">
        <a name="M000116"></a>

        <div class="method-heading">
          <a href="#M000116" class="method-signature">
          <span class="method-name">map_property</span><span class="method-args">(name)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Gets the mapping from a xml element name to a property. This looks up the
property map; if no entry is found the default value (which is the name of
the element) will be used.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000116-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000116-source">
<pre>
     <span class="ruby-comment cmt"># File lib/talia_util/hyper_importer/importer.rb, line 211</span>
211:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">map_property</span>(<span class="ruby-identifier">name</span>)
212:         <span class="ruby-identifier">property</span> = <span class="ruby-constant">PROPERTY_MAP</span>[<span class="ruby-identifier">name</span>]
213:         <span class="ruby-identifier">property</span> <span class="ruby-operator">||=</span> <span class="ruby-identifier">name</span>.<span class="ruby-identifier">underscore</span>
214:       <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000130" class="method-detail">
        <a name="M000130"></a>

        <div class="method-heading">
          <a href="#M000130" class="method-signature">
          <span class="method-name">open_from_url</span><span class="method-args">(url) {|io| ...}</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Opens the given (web) URL, using URL encoding and necessary substitutions.
The user must pass a block which will receive the io object from the url
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000130-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000130-source">
<pre>
     <span class="ruby-comment cmt"># File lib/talia_util/hyper_importer/importer.rb, line 567</span>
567:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">open_from_url</span>(<span class="ruby-identifier">url</span>)
568:         <span class="ruby-identifier">url</span> = <span class="ruby-constant">URI</span>.<span class="ruby-identifier">encode</span>(<span class="ruby-identifier">url</span>)
569:         <span class="ruby-identifier">url</span>.<span class="ruby-identifier">gsub!</span>(<span class="ruby-regexp re">/\[/</span>, <span class="ruby-value str">'%5B'</span>) <span class="ruby-comment cmt"># URI class doesn't like unescaped brackets</span>
570:         <span class="ruby-identifier">url</span>.<span class="ruby-identifier">gsub!</span>(<span class="ruby-regexp re">/\]/</span>, <span class="ruby-value str">'%5D'</span>)
571:         <span class="ruby-identifier">open_args</span> = [ <span class="ruby-identifier">url</span> ]
572:         <span class="ruby-identifier">open_args</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-ivar">@credentials</span> <span class="ruby-keyword kw">if</span>(<span class="ruby-ivar">@credentials</span>)
573: 
574:         <span class="ruby-keyword kw">begin</span>
575:           <span class="ruby-identifier">open</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">open_args</span>) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">io</span><span class="ruby-operator">|</span>
576:             <span class="ruby-keyword kw">yield</span>(<span class="ruby-identifier">io</span>)
577:           <span class="ruby-keyword kw">end</span>
578:         <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Exception</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
579:           <span class="ruby-identifier">raise</span>(<span class="ruby-constant">IOError</span>, <span class="ruby-node">&quot;Error loading #{url} for #{@source.uri} (when file: #{url}, open_args: [#{open_args.join(', ')}]) #{e}&quot;</span>)
580:         <span class="ruby-keyword kw">end</span>
581:       <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000128" class="method-detail">
        <a name="M000128"></a>

        <div class="method-heading">
          <a href="#M000128" class="method-signature">
          <span class="method-name">open_original_image_for</span><span class="method-args">(url) {|io| ...}</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Opens the &quot;original&quot; image for the given url. This will convert
the image to PNG image and the yield the io object for the PNG.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000128-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000128-source">
<pre>
     <span class="ruby-comment cmt"># File lib/talia_util/hyper_importer/importer.rb, line 500</span>
500:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">open_original_image_for</span>(<span class="ruby-identifier">url</span>)
501:         <span class="ruby-identifier">unconverted_file</span> = <span class="ruby-identifier">url</span>
502:         <span class="ruby-identifier">converted_file</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-constant">Dir</span>.<span class="ruby-identifier">tmpdir</span>, <span class="ruby-node">&quot;talia_convert_#{rand 10E16}&quot;</span>)
503:         <span class="ruby-identifier">clean_unconverted</span> = <span class="ruby-keyword kw">false</span> <span class="ruby-comment cmt"># Indicates if the unconverted file must be deleted</span>
504: 
505:         <span class="ruby-comment cmt"># Check if we need to download the unconverted file</span>
506:         <span class="ruby-keyword kw">if</span>(<span class="ruby-operator">!</span><span class="ruby-constant">File</span>.<span class="ruby-identifier">exists?</span>(<span class="ruby-identifier">url</span>))
507:           <span class="ruby-comment cmt"># First load this from the web to a temp file</span>
508:           <span class="ruby-identifier">tempfile</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-constant">Dir</span>.<span class="ruby-identifier">tmpdir</span>, <span class="ruby-node">&quot;talia_down_#{rand 10E16}#{File.extname(url)}&quot;</span>)
509:           <span class="ruby-identifier">open_from_url</span>(<span class="ruby-identifier">url</span>) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">io</span><span class="ruby-operator">|</span>
510:             <span class="ruby-constant">File</span>.<span class="ruby-identifier">open</span>(<span class="ruby-identifier">tempfile</span>) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">fio</span><span class="ruby-operator">|</span>
511:               <span class="ruby-identifier">fio</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">io</span>.<span class="ruby-identifier">read</span> <span class="ruby-comment cmt"># Download the file</span>
512:             <span class="ruby-keyword kw">end</span>
513:             <span class="ruby-identifier">url</span> = <span class="ruby-identifier">unconverted_file</span>
514:             <span class="ruby-identifier">clean_unconverted</span> = <span class="ruby-keyword kw">true</span>
515:           <span class="ruby-keyword kw">end</span>
516:         <span class="ruby-keyword kw">end</span>
517: 
518:         <span class="ruby-constant">TaliaCore</span><span class="ruby-operator">::</span><span class="ruby-constant">ImageConversions</span>.<span class="ruby-identifier">to_png</span>(<span class="ruby-identifier">unconverted_file</span>, <span class="ruby-identifier">converted_file</span>)
519:         <span class="ruby-constant">File</span>.<span class="ruby-identifier">open</span>(<span class="ruby-identifier">converted_file</span>) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">io</span><span class="ruby-operator">|</span>
520:           <span class="ruby-keyword kw">yield</span>(<span class="ruby-identifier">io</span>)
521:         <span class="ruby-keyword kw">end</span>
522: 
523:         <span class="ruby-constant">FileUtils</span>.<span class="ruby-identifier">rm</span>(<span class="ruby-identifier">converted_file</span>)
524:         <span class="ruby-constant">FileUtils</span>.<span class="ruby-identifier">rm</span>(<span class="ruby-identifier">unconverted_file</span>) <span class="ruby-keyword kw">if</span>(<span class="ruby-identifier">clean_unconverted</span>)
525:       <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000127" class="method-detail">
        <a name="M000127"></a>

        <div class="method-heading">
          <a href="#M000127" class="method-signature">
          <span class="method-name">prepare_image_from_existing!</span><span class="method-args">(iip_record, image_record, url, location)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Attempts to create an IipData object with pre-prepared images if possible
Returns true if (and only if) the object has been created with existing
data. Always fals if the data_record is not an IipData object or the
:prepared_images option is not set.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000127-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000127-source">
<pre>
     <span class="ruby-comment cmt"># File lib/talia_util/hyper_importer/importer.rb, line 474</span>
474:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">prepare_image_from_existing!</span>(<span class="ruby-identifier">iip_record</span>, <span class="ruby-identifier">image_record</span>, <span class="ruby-identifier">url</span>, <span class="ruby-identifier">location</span>)
475:         <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">false</span> <span class="ruby-keyword kw">unless</span>(<span class="ruby-identifier">iip_record</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">TaliaCore</span><span class="ruby-operator">::</span><span class="ruby-constant">DataTypes</span><span class="ruby-operator">::</span><span class="ruby-constant">IipData</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">image_record</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">TaliaCore</span><span class="ruby-operator">::</span><span class="ruby-constant">DataTypes</span><span class="ruby-operator">::</span><span class="ruby-constant">ImageData</span>))
476:         <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">false</span> <span class="ruby-keyword kw">unless</span>(<span class="ruby-identifier">import_options</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">import_options</span>[<span class="ruby-identifier">:prepared_images</span>])
477:         
478:         <span class="ruby-identifier">file_ext</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">extname</span>(<span class="ruby-identifier">url</span>)
479:         <span class="ruby-identifier">file_base</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">basename</span>(<span class="ruby-identifier">url</span>, <span class="ruby-identifier">file_ext</span>)
480: 
481:         <span class="ruby-identifier">thumb_file</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-identifier">import_options</span>[<span class="ruby-identifier">:prepared_images</span>], <span class="ruby-value str">'thumbs'</span>, <span class="ruby-node">&quot;#{file_base}.gif&quot;</span>)
482:         <span class="ruby-identifier">pyramid_file</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-identifier">import_options</span>[<span class="ruby-identifier">:prepared_images</span>], <span class="ruby-value str">'pyramids'</span>, <span class="ruby-node">&quot;#{file_base}.tif&quot;</span>)
483:         <span class="ruby-identifier">orig_file_pattern</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-identifier">import_options</span>[<span class="ruby-identifier">:prepared_images</span>], <span class="ruby-value str">'originals'</span>, <span class="ruby-node">&quot;#{file_base}.*&quot;</span>)
484:         <span class="ruby-comment cmt"># We need to fix the pattern, also the Dir[] doesn't like unescaped brackets</span>
485:         <span class="ruby-identifier">orig_file_pattern</span>.<span class="ruby-identifier">gsub!</span>(<span class="ruby-regexp re">/\[/</span>, <span class="ruby-value str">'\\['</span>)
486:         <span class="ruby-identifier">orig_file_pattern</span>.<span class="ruby-identifier">gsub!</span>(<span class="ruby-regexp re">/\]/</span>, <span class="ruby-value str">'\\]'</span>)
487:         <span class="ruby-identifier">orig_file_l</span> = <span class="ruby-constant">Dir</span>[<span class="ruby-identifier">orig_file_pattern</span>]
488:         <span class="ruby-identifier">raise</span>(<span class="ruby-constant">ArgumentError</span>, <span class="ruby-value str">'Original find not found for '</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">url</span>) <span class="ruby-keyword kw">unless</span>(<span class="ruby-identifier">orig_file_l</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>)
489:         <span class="ruby-identifier">orig_file</span> = <span class="ruby-identifier">orig_file_l</span>.<span class="ruby-identifier">first</span>
490:         <span class="ruby-identifier">assit_block</span> { <span class="ruby-node">%w(.jpg .jpeg .png)</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-constant">File</span>.<span class="ruby-identifier">extname</span>(<span class="ruby-identifier">orig_file</span>).<span class="ruby-identifier">downcase</span>) }
491:         
492:         <span class="ruby-identifier">iip_record</span>.<span class="ruby-identifier">create_from_existing</span>(<span class="ruby-identifier">thumb_file</span>, <span class="ruby-identifier">pyramid_file</span>)
493:         <span class="ruby-identifier">image_record</span>.<span class="ruby-identifier">create_from_file</span>(<span class="ruby-identifier">location</span>, <span class="ruby-identifier">orig_file</span>)
494: 
495:         <span class="ruby-keyword kw">true</span>
496:       <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000136" class="method-detail">
        <a name="M000136"></a>

        <div class="method-heading">
          <a href="#M000136" class="method-signature">
          <span class="method-name">primary_source</span><span class="method-args">(value = true)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Helper to indicate that the importer is for a primary <a
href="Importer.html#M000101">source</a> type. This can be used in the
importer subclass to &quot;tag&quot; the importer as a primary <a
href="Importer.html#M000101">source</a> importer.
</p>
<p>
You can use this in the importer class like <tt><a
href="Importer.html#M000136">primary_source</a> true</tt>
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000136-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000136-source">
<pre>
     <span class="ruby-comment cmt"># File lib/talia_util/hyper_importer/importer.rb, line 660</span>
660:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">primary_source</span>(<span class="ruby-identifier">value</span> = <span class="ruby-keyword kw">true</span>)
661:         <span class="ruby-comment cmt"># Assert that this is not called on the supertype. Due to the</span>
662:         <span class="ruby-comment cmt"># handling of class variables in ruby this would break the mechanism.</span>
663:         <span class="ruby-identifier">assit</span>(<span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">!=</span> <span class="ruby-constant">Importer</span>, <span class="ruby-value str">&quot;Must never call this method on superclass.&quot;</span>)
664:         <span class="ruby-ivar">@@primary_source</span> = <span class="ruby-identifier">value</span>
665:       <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000137" class="method-detail">
        <a name="M000137"></a>

        <div class="method-heading">
          <a href="#M000137" class="method-signature">
          <span class="method-name">primary_source?</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Checks if this is a primary <a href="Importer.html#M000101">source</a>
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000137-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000137-source">
<pre>
     <span class="ruby-comment cmt"># File lib/talia_util/hyper_importer/importer.rb, line 668</span>
668:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">primary_source?</span>
669:         <span class="ruby-keyword kw">if</span>(<span class="ruby-keyword kw">defined?</span>(<span class="ruby-ivar">@@primary_source</span>))
670:           <span class="ruby-ivar">@@primary_source</span>
671:         <span class="ruby-keyword kw">else</span>
672:           <span class="ruby-keyword kw">false</span>
673:         <span class="ruby-keyword kw">end</span>
674:       <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000126" class="method-detail">
        <a name="M000126"></a>

        <div class="method-heading">
          <a href="#M000126" class="method-signature">
          <span class="method-name">process_content_type</span><span class="method-args">(content_type, extension)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Checks the given content_type and tries to make some kind of MIME type of
it. The extension will be used for &quot;dubios&quot; content types, that
have something like &#8216;image&#8217; specified
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000126-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000126-source">
<pre>
     <span class="ruby-comment cmt"># File lib/talia_util/hyper_importer/importer.rb, line 443</span>
443:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">process_content_type</span>(<span class="ruby-identifier">content_type</span>, <span class="ruby-identifier">extension</span>)
444:         <span class="ruby-identifier">content_type</span> = <span class="ruby-identifier">content_type</span>.<span class="ruby-identifier">downcase</span>
445:         <span class="ruby-identifier">content_type</span> = <span class="ruby-identifier">extension</span>[<span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>] <span class="ruby-keyword kw">if</span>(<span class="ruby-identifier">content_type</span> <span class="ruby-operator">==</span> <span class="ruby-value str">'image'</span>)
446:         <span class="ruby-keyword kw">case</span> <span class="ruby-identifier">content_type</span>
447:         <span class="ruby-keyword kw">when</span> <span class="ruby-value str">'generic xml'</span><span class="ruby-operator">:</span>
448:             <span class="ruby-value str">'text/xml'</span>
449:         <span class="ruby-keyword kw">when</span> <span class="ruby-value str">'html'</span>, <span class="ruby-value str">'xml'</span><span class="ruby-operator">:</span>
450:             <span class="ruby-node">&quot;text/#{content_type}&quot;</span>
451:         <span class="ruby-keyword kw">when</span> <span class="ruby-value str">'xhtml'</span><span class="ruby-operator">:</span>
452:             <span class="ruby-value str">'application/xhtml+xml'</span>
453:         <span class="ruby-keyword kw">when</span> <span class="ruby-value str">'hnml'</span>, <span class="ruby-value str">'tei'</span>, <span class="ruby-value str">'tei-p4'</span>, <span class="ruby-value str">'tei-p5'</span>, <span class="ruby-value str">'gml'</span>, <span class="ruby-value str">'wittei'</span><span class="ruby-operator">:</span>
454:             <span class="ruby-node">&quot;application/xml+#{content_type}&quot;</span>
455:         <span class="ruby-keyword kw">when</span> <span class="ruby-value str">'jpg'</span>, <span class="ruby-value str">'jpeg'</span><span class="ruby-operator">:</span>
456:             <span class="ruby-value str">'image/jpeg'</span>
457:         <span class="ruby-keyword kw">when</span> <span class="ruby-value str">'gif'</span><span class="ruby-operator">:</span>
458:             <span class="ruby-value str">'image/gif'</span>
459:         <span class="ruby-keyword kw">when</span> <span class="ruby-value str">'tif'</span>, <span class="ruby-value str">'tiff'</span><span class="ruby-operator">:</span>
460:             <span class="ruby-value str">'image/tiff'</span>
461:         <span class="ruby-keyword kw">when</span> <span class="ruby-value str">'png'</span><span class="ruby-operator">:</span>
462:             <span class="ruby-value str">'image/png'</span>
463:         <span class="ruby-keyword kw">when</span> <span class="ruby-value str">'pdf'</span><span class="ruby-operator">:</span>
464:             <span class="ruby-value str">'application/pdf'</span>
465:         <span class="ruby-keyword kw">else</span>
466:           <span class="ruby-identifier">assit_fail</span>(<span class="ruby-node">&quot;Unknown type #{content_type}&quot;</span>)
467:         <span class="ruby-keyword kw">end</span>
468:       <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000133" class="method-detail">
        <a name="M000133"></a>

        <div class="method-heading">
          <a href="#M000133" class="method-signature">
          <span class="method-name">quick_add_predicate</span><span class="method-args">(source, predicate, value)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
This is a fast-add-hack for a predicate. It basically bypasses the whole
getting of a predicate list and simply forces the values to the database.
This should avoid any database hits except the one that actually adds the
elements.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000133-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000133-source">
<pre>
     <span class="ruby-comment cmt"># File lib/talia_util/hyper_importer/importer.rb, line 624</span>
624:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">quick_add_predicate</span>(<span class="ruby-identifier">source</span>, <span class="ruby-identifier">predicate</span>, <span class="ruby-identifier">value</span>)
625:         <span class="ruby-identifier">predicate</span> = <span class="ruby-identifier">predicate</span>.<span class="ruby-identifier">uri</span> <span class="ruby-keyword kw">if</span>(<span class="ruby-identifier">predicate</span>.<span class="ruby-identifier">respond_to?</span>(<span class="ruby-identifier">:uri</span>))
626:         <span class="ruby-comment cmt"># We need to manually create the relation, to add the predicate_url</span>
627:         <span class="ruby-identifier">to_add</span> = <span class="ruby-constant">TaliaCore</span><span class="ruby-operator">::</span><span class="ruby-constant">SemanticRelation</span>.<span class="ruby-identifier">new</span>
628:         <span class="ruby-identifier">to_add</span>.<span class="ruby-identifier">predicate_uri</span> = <span class="ruby-identifier">predicate</span>
629:         <span class="ruby-keyword kw">if</span>(<span class="ruby-identifier">value</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">TaliaCore</span><span class="ruby-operator">::</span><span class="ruby-constant">ActiveSource</span>) <span class="ruby-operator">||</span> <span class="ruby-identifier">value</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">TaliaCore</span><span class="ruby-operator">::</span><span class="ruby-constant">SemanticProperty</span>))
630:           <span class="ruby-identifier">to_add</span>.<span class="ruby-identifier">object</span> = <span class="ruby-identifier">value</span>
631:         <span class="ruby-keyword kw">else</span>
632:           <span class="ruby-identifier">prop</span> = <span class="ruby-constant">TaliaCore</span><span class="ruby-operator">::</span><span class="ruby-constant">SemanticProperty</span>.<span class="ruby-identifier">new</span>
633:           <span class="ruby-identifier">prop</span>.<span class="ruby-identifier">value</span> = <span class="ruby-identifier">value</span>
634:           <span class="ruby-identifier">to_add</span>.<span class="ruby-identifier">object</span> = <span class="ruby-identifier">prop</span>
635:         <span class="ruby-keyword kw">end</span>
636:         <span class="ruby-identifier">to_add</span>.<span class="ruby-identifier">subject</span> = <span class="ruby-identifier">source</span>
637:         <span class="ruby-identifier">to_add</span>.<span class="ruby-identifier">save!</span>
638:       <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000121" class="method-detail">
        <a name="M000121"></a>

        <div class="method-heading">
          <a href="#M000121" class="method-signature">
          <span class="method-name">set_catalog_on</span><span class="method-args">(src)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Sets the catalog on the given <a href="Importer.html#M000101">source</a>
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000121-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000121-source">
<pre>
     <span class="ruby-comment cmt"># File lib/talia_util/hyper_importer/importer.rb, line 320</span>
320:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">set_catalog_on</span>(<span class="ruby-identifier">src</span>)
321:         <span class="ruby-keyword kw">if</span>(<span class="ruby-identifier">src</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">TaliaCore</span><span class="ruby-operator">::</span><span class="ruby-constant">ExpressionCard</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">src</span>.<span class="ruby-identifier">catalog</span>)
322:           <span class="ruby-identifier">catalog</span> = <span class="ruby-identifier">get_catalog</span>()
323:           <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">catalog</span>.<span class="ruby-identifier">nil?</span>
324:             <span class="ruby-identifier">src</span>.<span class="ruby-identifier">catalog</span> = <span class="ruby-constant">TaliaCore</span><span class="ruby-operator">::</span><span class="ruby-constant">Catalog</span>.<span class="ruby-identifier">default_catalog</span>
325:           <span class="ruby-keyword kw">else</span>
326:             <span class="ruby-identifier">src</span>.<span class="ruby-identifier">catalog</span> = <span class="ruby-identifier">catalog</span>
327:           <span class="ruby-keyword kw">end</span>
328:         <span class="ruby-keyword kw">end</span>
329:       <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000140" class="method-detail">
        <a name="M000140"></a>

        <div class="method-heading">
          <a href="#M000140" class="method-signature">
          <span class="method-name">underscore</span><span class="method-args">(camel_cased_word)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Stole from Rails
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000140-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000140-source">
<pre>
     <span class="ruby-comment cmt"># File lib/talia_util/hyper_importer/importer.rb, line 688</span>
688:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">underscore</span>(<span class="ruby-identifier">camel_cased_word</span>)
689:         <span class="ruby-identifier">camel_cased_word</span>.<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp re">/::/</span>, <span class="ruby-value str">'/'</span>).
690:           <span class="ruby-identifier">gsub</span>(<span class="ruby-regexp re">/([A-Z]+)([A-Z][a-z])/</span>,<span class="ruby-value str">'\1_\2'</span>).
691:           <span class="ruby-identifier">gsub</span>(<span class="ruby-regexp re">/([a-z\d])([A-Z])/</span>,<span class="ruby-value str">'\1_\2'</span>).
692:           <span class="ruby-identifier">tr</span>(<span class="ruby-value str">&quot;-&quot;</span>, <span class="ruby-value str">&quot;_&quot;</span>).
693:           <span class="ruby-identifier">downcase</span>
694:       <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>


    </div>


  </div>


<div id="validator-badges">
  <p><small><a href="http://validator.w3.org/check/referer">[Validate]</a></small></p>
</div>

</body>
</html>