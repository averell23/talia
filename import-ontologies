# Script to use to import RDFS ontologies
$: << File.dirname(__FILE__) + '/vendor/plugins/ActiveRDF/lib/'

require 'rake'
require 'yaml'
require 'active_rdf'

task :default => :import

task :import do
  # some useful constants
  TITLE = "\nImport-Ontologies Rake file\nVersion: 1.0 by Michele Nucci (mik.nucci _at_ gmail.com) \n\n"
  
  # read the command line parameters
  # example: rake -f import-ontologies rdfdir=./rdf/ontologies/ [resetdb=1|0|y|n]
  #
  # parameters:
  # rdfdir:         the path of the directory in which the ontologies are stored
  # resetdb:        completly reset the DB before import the ontology file (initialize a new DB)
  # ontologysyntax: (optionals for ntriples) specify the ontology syntas ntriples/rdfxml
  rdfdir          = ENV['rdfdir']
  resetdb         = ENV['reset']
  ontology_syntax = ENV['ontologysyntax']
  
  if rdfdir
    # check if the specified directory really exists
    if !FileTest.exists?(rdfdir)
      puts TITLE
      puts "Error: the specified directory does not exists!\n\n"
      exit(1)
    end
    
    # find RDF/RDFS files
    puts TITLE
    puts "--> Start finding RDF/RDFS file to load...\n"
    
    # get the file list (only rdf and rdfs file)
    file_list = Dir[rdfdir+'*.{rdf,rdfs}']
    
    if file_list.size > 0
      puts "\tFound " << file_list.size.to_s << " files."
      puts "--> Try to importing rdf/rdfs file into the triple-store..."
      
      # read triplestore configuration file
      # check for exception in opening the triplestore configuration file
      begin
        tps_config = YAML.load_file('./config/triplestore.yml')
      rescue
        puts "\nERROR: triplestore.yml does not exists or it is impossible to read it.\n\n"
        exit(1)
      end
      
      # open a connection to the triple-store to load the found files
      if resetdb && ( resetdb == 1 || resetdb.downcase == 'y' ) 
        adapter = ConnectionPool.add_data_source :type => tps_config['adapter'].to_sym,
                                                 :name => tps_config['name'],
                                                 :location => tps_config['dbms'],
                                                 :host => tps_config['host'],
                                                 :port => tps_config['port'],
                                                 :user => tps_config['username'],
                                                 :password => tps_config['password'],
                                                 :new => 'yes'
        
      else
        adapter = ConnectionPool.add_data_source :type => tps_config['adapter'].to_sym,
                                                 :name => tps_config['name'],
                                                 :location => tps_config['dbms'],
                                                 :host => tps_config['host'],
                                                 :port => tps_config['port'],
                                                 :user => tps_config['username'],
                                                 :password => tps_config['password']
      end

      # check if the connection to te triplestore is ok...otherwise exit the script
      if !adapter
        puts "\nERROR: impossible to open a connection to the triples store. Check your system and your configuration files!\n\n"
        exit(1)
      end
      
      # try to load every file into the triple store
      file_list.each{|file|
        puts "\tLoading: " << file.to_s
        
        # load rdf/rdfs file into triplestore
        begin
          if ontology_syntax
            adapter.load(file, ontology_syntax)
          else
            adapter.load(file)
          end
        rescue
          puts "\tProblem loading: " << file.to_s << ". File not loaded!"
        end
      }
      
      puts "\n--> Importing rdf/rdfs file: complete!\n\n"
    end
    
  else
    # basic parameters not specified
    puts TITLE
    puts "Syntax example: rake -f import-ontologies rdfdir=./rdf/ontologies/ [resetdb=n|y] [ontologysyntax=rdfxml|ntriples]"
  end
  
end
